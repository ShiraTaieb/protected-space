<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="utf-8" />
    <title>הוספת כתובת - מיקום במפה</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <h2>בחר מיקום במפה</h2>
    <div id="map"></div>
    <br />
    <form id="addressForm">
        <label>תעודת זהות: <input type="text" id="userId" required></label><br>
        <label>איש קשר: <input type="text" name="ContactPerson" required></label><br>
        <label>טלפון: <input type="text" name="PhoneNumber" required></label><br>
        <label>קיבולת: <input type="text" name="Capacity" required></label><br>
        <label>כמות נוכחית: <input type="number" name="CurrentNumberOfPeople" value="0"></label><br>
        <label>מזהה מבנה (TypeStructureId): <input type="number" name="TypeStructureId" required></label><br>
        <label>פתוח? <input type="checkbox" name="Open"></label><br>
        <input type="submit" value="שמור כתובת">
    </form>

    <script>
        let map;
        let latitude = 0;
        let longitude = 0;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 32.0853, lng: 34.7818 },
                zoom: 10,
            });

            let marker;

            map.addListener("click", (e) => {
                latitude = e.latLng.lat();
                longitude = e.latLng.lng();

                if (marker) {
                    marker.setPosition(e.latLng);
                } else {
                    marker = new google.maps.Marker({
                        position: e.latLng,
                        map: map,
                    });
                }
            });
        }

        document.getElementById("addressForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            // לולאה לבדוק תקינות ת"ז עד שמתקבלת ת"ז בת 9 ספרות
            let userId = document.getElementById("userId").value.trim();

            while (!/^\d{9}$/.test(userId)) {
                alert("אנא הזן תעודת זהות בת 9 ספרות בלבד");
                userId = prompt("אנא הזן תעודת זהות בת 9 ספרות בלבד:");
                if (userId === null) {
                    // אם המשתמש לחץ ביטול, הפסק שליחת הטופס
                    return;
                }
                userId = userId.trim();
                document.getElementById("userId").value = userId;
            }

            const formData = new FormData(this);
            const address = {
                ContactPerson: formData.get("ContactPerson"),
                PhoneNumber: formData.get("PhoneNumber"),
                Capacity: formData.get("Capacity"),
                CurrentNumberOfPeople: parseInt(formData.get("CurrentNumberOfPeople")),
                TypeStructureId: parseInt(formData.get("TypeStructureId")),
                Open: formData.get("Open") === "on",
                Latitude: latitude,
                Longitude: longitude,
                Date: new Date().toISOString()
            };

            const response = await fetch(`https://localhost:7132/api/Address?id=${userId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(address),
            });

            if (response.ok) {
                alert("הכתובת נשמרה בהצלחה!");
                // אפשר לאפס טופס ומפה לפי הצורך
                this.reset();
                if (typeof marker !== "undefined") {
                    marker.setMap(null);
                }
            } else {
                const errorText = await response.text();
                alert("שגיאה בשמירת הכתובת: " + errorText);
            }
        });
    </script>

    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmVDk3IM1RiN1jIlZCNKWtt8xqLgLK41I&callback=initMap">
    </script>
</body>
</html>
